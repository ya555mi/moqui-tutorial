<?xml version="1.0" encoding="UTF-8"?>

<services xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/service-definition-2.1.xsd">

    <!-- Order & Related Services -->
    <service verb="create" noun="CreateOrder" displayName="Create the order">
        <in-parameters>
            <parameter name="orderName" required="true"/>
            <parameter name="currencyUomId" required="true"/>
            <parameter name="salesChannelEnumId" required="true"/>
            <parameter name="statusId" required="true"/>
            <parameter name="productStoreId" required="true"/>
            <parameter name="placedDate" required="true"/>
            <parameter name="approvedDate" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="orderId" required="true"/>
        </out-parameters>
        <actions>
            <entity-find entity-name="mantle.party.Party" list="orderCreateList">
                <econdition field-name="partyId" value="CustJqp"/>
            </entity-find>
            <if condition="orderCreateList">
                <then>
                    <service-call name="create#mantle.order.OrderHeader" in-map="context" out-map="context"/>
                </then>
            </if>
        </actions>
    </service>


    <service verb="create" noun="CreateOrderPart" displayName="Create the order Part">
        <in-parameters>
            <parameter name="orderId" required="true"/>
            <parameter name="partName" required="true"/>
            <parameter name="facilityId" required="true"/>
            <parameter name="shipmentMethodEnumId" required="true"/>
            <parameter name="customerPartyId" required="true"/>
            <parameter name="item_details" type="List">
                <parameter name="orderEntry" type="Map">
                    <parameter name="productId"/>
                    <parameter name="itemDescription"/>
                    <parameter name="quantity"/>
                    <parameter name="unitAmount"/>
                </parameter>
            </parameter>
        </in-parameters>
        <out-parameters>
            <parameter name="orderId" required="true"/>
            <parameter name="orderPartSeqId" required="true"/>
        </out-parameters>
        <actions>
            <entity-find entity-name="mantle.order.OrderHeader" list="orderCreateList">
                <econdition field-name="orderId"/>
            </entity-find>
            <if condition="orderCreateList">
                <service-call name="create#mantle.order.OrderPart" in-map="context" out-map="context"/>
            </if>
            <entity-find entity-name="mantle.order.OrderPart" list="orderList">
                <econdition field-name="orderId"/>
                <econdition field-name="customerPartyId"/>
            </entity-find>
            <set field="productId" from="item_details.productId"/>
            <set field="unitAmount" from="item_details.unitAmount"/>
            <entity-find entity-name="mantle.product.Product" list="productList">
                <econdition field-name="productId"/>
            </entity-find>
            <iterate list="productList" entry="product">
                <set field="productId" from="product.productId"/>
            </iterate>
            <iterate list="orderList" entry="order">
                <set field="orderId" from="order.orderId"/>
            </iterate>
            <if condition="orderList &amp;&amp; productList">
                <then>
                    <service-call name="create#mantle.order.OrderItem"
                                  in-map="context+[orderId:orderId,productId:productId,
                                  itemDescription:item_details.itemDescription,
                                  unitAmount:unitAmount,quantity:quantity]"
                                  out-map="context"/>
                </then>
            </if>
        </actions>
    </service>


    <service verb="store" noun="UpdateOrder" displayName="Update the order">
        <in-parameters>
            <parameter name="orderId" required="true"/>
            <parameter name="orderName"/>
            <parameter name="currencyUomId"/>
            <parameter name="salesChannelEnumId"/>
            <parameter name="statusId"/>
            <parameter name="productStoreId"/>
            <parameter name="placedDate"/>
            <parameter name="approvedDate"/>
            <parameter name="grandTotal"/>
        </in-parameters>
        <out-parameters>
            <parameter name="orderId" required="true"/>
            <parameter name="orderName" required="true"/>
            <parameter name="currencyUomId" required="true"/>
            <parameter name="salesChannelEnumId" required="true"/>
            <parameter name="statusId" required="true"/>
            <parameter name="productStoreId" required="true"/>
            <parameter name="placedDate" required="true"/>
            <parameter name="approvedDate" required="true"/>
            <parameter name="grandTotal" required="true"/>
        </out-parameters>
        <actions>
            <entity-find entity-name="mantle.order.OrderHeader" list="orderUpdateList">
                <econdition field-name="orderId"/>
            </entity-find>
            <if condition="orderUpdateList">
                <then>
                    <service-call name="update#mantle.order.OrderHeader" in-map="context" out-map="context"/>
                </then>
            </if>
        </actions>
    </service>


    <service verb="get" noun="OrderDisplayInfo">
        <in-parameters>
            <parameter name="orderId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="orders" type="list">
                <parameter name="orderId" required="false"/>
                <parameter name="orderName" required="false"/>
                <parameter name="currencyUomId" required="false"/>
                <parameter name="placedDate" required="true"/>
                <parameter name="grandTotal" required="false"/>
                <parameter name="customers_deatails" type="map">
                    <parameter name="partyId"/>
                    <parameter name="firstName"/>
                    <parameter name="middleName"/>
                    <parameter name="lastName"/>
                </parameter>
                <parameter name="order_parts" type="list">
                    <parameter name="orderparts" type="map">
                        <parameter name="orderPartSeqId"/>
                        <parameter name="partName"/>
                        <parameter name="facilityId"/>
                        <parameter name="shipmentMethodEnumId"/>
                        <parameter name="partStatusId"/>
                        <parameter name="partTotal"/>
                        <parameter name="item_details" type="list">
                            <parameter name="item_map" type="map">
                                <parameter name="orderItemSeqId"/>
                                <parameter name="productId"/>
                                <parameter name="itemDescription"/>
                                <parameter name="quantity"/>
                                <parameter name="unitAmount"/>
                            </parameter>
                        </parameter>

                    </parameter>
                </parameter>
            </parameter>
        </out-parameters>
        <actions>
            <set field="customers_deatails" from="[:]"/>
            <set field="orders" from="[]"/>
            <set field="order_parts" from="[]"/>
            <set field="item_details" from="[]"/>
            <entity-find entity-name="mantle.order.OrderHeader" list="orderList">
                <econdition field-name="orderId"/>
                <select-field field-name="orderId"/>
                <select-field field-name="orderName"/>
                <select-field field-name="currencyUomId"/>
                <select-field field-name="placedDate"/>
                <select-field field-name="grandTotal"/>
            </entity-find>
            <entity-find entity-name="mantle.order.OrderPart" list="orderPartList">
                <econdition field-name="orderId"/>
                <select-field field-name="orderPartSeqId"/>
                <select-field field-name="customerPartyId"/>
                <select-field field-name="partName"/>
                <select-field field-name="facilityId"/>
                <select-field field-name="shipmentMethodEnumId"/>
                <select-field field-name="statusId"/>
                <select-field field-name="partTotal"/>
            </entity-find>
            <entity-find entity-name="mantle.order.OrderItem" list="orderItemList">
                <econdition field-name="orderId"/>
                <select-field field-name="orderItemSeqId"/>
                <select-field field-name="productId"/>
                <select-field field-name="itemDescription"/>
                <select-field field-name="quantity"/>
                <select-field field-name="unitAmount"/>
            </entity-find>
            <set field="partyId" from="orderPartList.customerPartyId"/>
            <entity-find entity-name="mantle.party.Person" list="personList">
                <econdition field-name="partyId"/>
                <select-field field-name="partyId"/>
                <select-field field-name="firstName"/>
                <select-field field-name="middleName"/>
                <select-field field-name="lastName"/>
            </entity-find>
            <iterate list="personList" entry="person">
                <set field="partyId" from="person.partyId"/>
                <set field="firstName" from="person.firstName"/>
                <set field="middleName" from="person.middleName"/>
                <set field="lastName" from="person.lastName"/>
            </iterate>
            <iterate list="orderPartList" entry="orderPart">
                <set field="orderPartSeqId" from="orderPart.orderPartSeqId"/>
                <set field="partName" from="orderPart.partName"/>
                <set field="facilityId" from="orderPart.facilityId"/>
                <set field="shipmentMethodEnumId" from="orderPart.shipmentMethodEnumId"/>
                <set field="statusId" from="orderPart.statusId"/>
                <set field="partTotal" from="orderPart.partTotal"/>
            </iterate>
            <iterate list="orderList" entry="ordersmap">
                <set field="orderId" from="ordersmap.orderId"/>
                <set field="orderName" from="ordersmap.orderName"/>
                <set field="currencyUomId" from="ordersmap.currencyUomId"/>
                <set field="placedDate" from="ordersmap.placedDate"/>
                <set field="grandTotal" from="ordersmap.grandTotal"/>
            </iterate>
            <iterate list="orderItemList" entry="orderItems">
                <set field="orderItemSeqId" from="orderItems.orderItemSeqId"/>
                <set field="productId" from="orderItems.productId"/>
                <set field="itemDescription" from="orderItems.itemDescription"/>
                <set field="quantity" from="orderItems.quantity"/>
                <set field="unitAmount" from="orderItems.unitAmount"/>
                <set field="item_details" from="item_details+[orderItemSeqId:orderItemSeqId,productId:productId,
                        itemDescription:itemDescription,quantity:quantity,
                        unitAmount:unitAmount]"/>
            </iterate>
            <set field="customers_deatails" from="customers_deatails+[partyId:partyId,firstName:firstName,
                    middleName:middleName,lastName:lastName]"/>

            <set field="order_parts" from="order_parts+[orderPartSeqId:orderPartSeqId,partName:partName,
                    facilityId:facilityId,shipmentMethodEnumId:shipmentMethodEnumId,
                    statusId:statusId,partTotal:partTotal,item_details:item_details]"/>
            <set field="orders" from="orders+[orderId:orderId,orderName:orderName,currencyUomId:currencyUomId,
                    placedDate:placedDate,grandTotal:grandTotal,customers_deatails:customers_deatails,
                    order_parts:order_parts]"/>
        </actions>
    </service>


    <service verb="get" noun="OrderDetails">
        <out-parameters>
            <parameter name="orders" type="list">
                <parameter name="orderId" required="false"/>
                <parameter name="orderName" required="false"/>
                <parameter name="currencyUomId" required="false"/>
                <parameter name="placedDate" required="true"/>
                <parameter name="grandTotal" required="false"/>
                <parameter name="customers_deatails" type="map">
                    <parameter name="partyId"/>
                    <parameter name="firstName"/>
                    <parameter name="middleName"/>
                    <parameter name="lastName"/>
                </parameter>
                <parameter name="order_parts" type="list">
                    <parameter name="orderparts" type="map">
                        <parameter name="orderPartSeqId"/>
                        <parameter name="partName"/>
                        <parameter name="facilityId"/>
                        <parameter name="shipmentMethodEnumId"/>
                        <parameter name="partStatusId"/>
                        <parameter name="partTotal"/>
                        <parameter name="item_details" type="list">
                            <parameter name="item_map" type="map">
                                <parameter name="orderItemSeqId"/>
                                <parameter name="productId"/>
                                <parameter name="itemDescription"/>
                                <parameter name="quantity"/>
                                <parameter name="unitAmount"/>
                            </parameter>
                        </parameter>

                    </parameter>
                </parameter>
            </parameter>
        </out-parameters>
        <actions>
            <set field="customers_deatails" from="[:]"/>
            <set field="orders" from="[]"/>
            <set field="order_parts" from="[]"/>
            <set field="item_details" from="[]"/>
            <set field="persons" from="[]"/>
            <entity-find entity-name="mantle.order.OrderHeader" list="orderList">
                <select-field field-name="orderId"/>
                <select-field field-name="orderName"/>
                <select-field field-name="currencyUomId"/>
                <select-field field-name="placedDate"/>
                <select-field field-name="grandTotal"/>
            </entity-find>
            <entity-find entity-name="mantle.order.OrderPart" list="orderPartList">
                <select-field field-name="orderPartSeqId"/>
                <select-field field-name="customerPartyId"/>
                <select-field field-name="partName"/>
                <select-field field-name="facilityId"/>
                <select-field field-name="shipmentMethodEnumId"/>
                <select-field field-name="statusId"/>
                <select-field field-name="partTotal"/>
            </entity-find>
            <entity-find entity-name="mantle.order.OrderItem" list="orderItemList">
                <select-field field-name="orderItemSeqId"/>
                <select-field field-name="productId"/>
                <select-field field-name="itemDescription"/>
                <select-field field-name="quantity"/>
                <select-field field-name="unitAmount"/>
            </entity-find>
            <entity-find entity-name="mantle.party.Person" list="personList">
                <select-field field-name="partyId"/>
                <select-field field-name="firstName"/>
                <select-field field-name="middleName"/>
                <select-field field-name="lastName"/>
            </entity-find>
            <iterate list="orderList" entry="ordersHeadersMap">
                <set field="orderId" from="ordersHeadersMap.orderId"/>
                <set field="orderName" from="ordersHeadersMap.orderName"/>
                <set field="currencyUomId" from="ordersHeadersMap.currencyUomId"/>
                <set field="placedDate" from="ordersHeadersMap.placedDate"/>
                <set field="grandTotal" from="ordersHeadersMap.grandTotal"/>
                <iterate list="personList" entry="person">
                    <set field="partyId" from="person.partyId"/>
                    <set field="firstName" from="person.firstName"/>
                    <set field="middleName" from="person.middleName"/>
                    <set field="lastName" from="person.lastName"/>
                    <iterate list="orderPartList" entry="orderPart">
                        <set field="orderPartSeqId" from="orderPart.orderPartSeqId"/>
                        <set field="partName" from="orderPart.partName"/>
                        <set field="facilityId" from="orderPart.facilityId"/>
                        <set field="shipmentMethodEnumId" from="orderPart.shipmentMethodEnumId"/>
                        <set field="statusId" from="orderPart.statusId"/>
                        <set field="partTotal" from="orderPart.partTotal"/>

                        <iterate list="orderItemList" entry="orderItems">
                            <set field="orderItemSeqId" from="orderItems.orderItemSeqId"/>
                            <set field="productId" from="orderItems.productId"/>
                            <set field="itemDescription" from="orderItems.itemDescription"/>
                            <set field="quantity" from="orderItems.quantity"/>
                            <set field="unitAmount" from="orderItems.unitAmount"/>
                        </iterate>
                    </iterate>
                </iterate>
                <set field="customers_deatails" from="customers_deatails+[partyId:partyId,firstName:firstName,
                        middleName:middleName,lastName:lastName]"/>
                <set field="item_details" from="item_details+[orderItemSeqId:orderItemSeqId,productId:productId,
                        itemDescription:itemDescription,quantity:quantity,
                        unitAmount:unitAmount]"/>
                <set field="order_parts" from="order_parts+[orderPartSeqId:orderPartSeqId,partName:partName,
                        facilityId:facilityId,shipmentMethodEnumId:shipmentMethodEnumId,
                        statusId:statusId,partTotal:partTotal,item_details:item_details]"/>
                <set field="orders" from="orders+[orderId:orderId,orderName:orderName,currencyUomId:currencyUomId,
                        placedDate:placedDate
                        ,grandTotal:grandTotal,customers_deatails:customers_deatails,order_parts:order_parts]"/>
            </iterate>
        </actions>
    </service>

</services>
